<!DOCTYPE html>
<html lang="en">
    <head>
	<meta charset="utf-8">
        <script src="js/phaser.min.js"></script>
    </head>
    <body style="margin:0px">
	
	<!--Copied from Phaser's Getting Started Tutorial -->
	<script type="text/javascript">
	 var w = 800;
	 var h = 512;
	 var game = new Phaser.Game(w, h, Phaser.AUTO, '', { preload: preload, create: create, update: update });
	 
	 var timerText;
	 var player; var q1; var q2; var finish; var background; var barrier; var map;
	 var q1asked = false; var q2asked = false; var finished = false;
	 var score = 0;

	 
	 function preload() {
	     game.load.tilemap('tilemap', 'assets/map.json', null, Phaser.Tilemap.TILED_JSON);
	     game.load.image('roadTiles', 'models/roads/preview.jpg');
	     game.load.image('grassTiles', 'models/roads/grass.png');
	     game.load.spritesheet('student', 'assets/student.png', 50, 50);
	     game.load.image('answeroption', 'assets/question_backdrop.jpg');
	     game.load.image('norman', 'assets/nr-cone.jpg');
	     game.load.image('ming', 'assets/ming.jpg');
	     game.load.spritesheet('event', 'assets/event.png', 30, 512);

	     game.load.image('dewick', 'assets/dewick.jpg');
	 }
	 
	 function create() {
	     //  We're going to be using physics, BUT WE MAY CHANGE TO BOX2D
	     game.physics.startSystem(Phaser.Physics.ARCADE);
	     
	     //  Background 
	     map = game.add.tilemap('tilemap');
	     map.addTilesetImage('road', 'roadTiles');
	     map.addTilesetImage('grass', 'grassTiles');
	     
	     // create background, add collisions
	     barrier = map.createLayer('Barrier');
	     background = map.createLayer('Background')
	     barrier.resizeWorld();
	     
	     map.setCollisionBetween(1, 100, true, 'Barrier');
	     
	     // The player and its settings
	     player = game.add.sprite(50, game.world.height - 300, 'student');
	     q1     = game.add.sprite(1220, 0, 'event');
	     q2     = game.add.sprite(2650, 0, 'event');
	     finish = game.add.sprite(4080, 0, 'event');

	     dewick = game.add.sprite(4120, 64, 'dewick');
	     dewick.scale.setTo(.57, .57);

	     q2.alpha = 0;
	     q1.alpha = 0;
	     finish.alpha = 0;
	     
	     player.animations.add('rwalk', [0,1]);
	     player.animations.add('lwalk', [2,3]);
	     player.animations.add('celebrate', [4,5]);
	     
	     //  We need to enable physics on the player
	     game.physics.arcade.enable(player);
	     game.physics.arcade.enable(q1);
	     game.physics.arcade.enable(q2);
	     game.physics.arcade.enable(finish);
	     
	     //  Player physics properties.
	     player.body.collideWorldBounds = true;
	     game.camera.follow(player);
	     
	     cursors = game.input.keyboard.createCursorKeys();
	     
	     //  Create our Timer
	     timer = game.time.create(false);
	     
	     //  Set a TimerEvent to occur after 1 seconds
	     timer.loop(1000, updateScore, this);
	     timer.start();
	     
	     timerText = game.add.text(
		 16, 16, 'Time: 0',
		 { fontSize: '32px', fill: '#000', fixedToCamera : true});
	     
	     timerText.fixedToCamera = true;
	     timerText.cameraOffset.setTo(16, 16);
	 }
	 
	 function updateScore(){
	     score++;
	     timerText.text = "Time: " + score;
	 }
	 
	 function endGame(){
	     // Print "Game Over! \n High Scores"
	     var style = { font: "50px Arial", fill: "#000000",
			   align: "center" };
	     var text = "Game Over!\n High scores:";
	     t = game.add.text(game.world.centerX-150, game.world.centerY-200,
			   text, style);
	     t.fixedToCamera = true;
	     t.cameraOffset.setTo(220, 200);
	     game.camera.follow(null);
	     
	     style = { font: "25px Arial", fill: "#fff", align: "center" };
	     
	     // Send XMLHttpRequest to database with current user info
	     // and retrieve the top 10 high scores
	     loadData(function(responseText) {
		 var data = JSON.parse(responseText).data;
		 // Print each instance of high score
		 for (var i = 0; i < data.length; i++) {
		     text = (i+1) + ". " + data[i].username + " " +
			    data[i].email + " " + data[i].score + "\n";
		     game.add.text(game.world.centerX-150,
				   game.world.centerY-90+i*25, text, style);
		 }
	     });
	 }
	 // Send an XMLHttpRequest to database w/ current user info.
	 // Calls callback function with the results
	 // TODO: perhaps a better way to get user info than "prompt"?
	 //        (kind of annoying)
	 function loadData(callback) {
	     var request = new XMLHttpRequest();
	     var myurl = "http://localhost:3000/submit";
	     var username = prompt("Please enter your username", "");
	     var email = prompt("Please enter your email",
				"example01@tufts.edu");
	     
	     // Validate email with regex
	     var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
	     
	     while (! re.test(email)) {
		 email = prompt("Please re-enter your email",
				"example01@tufts.edu");
	     }
	     
	     var params = "username=" + username + "&email=" + email +
			  "&score=" + score;
	     
	     request.onreadystatechange = function() {
		 if (request.readyState == 4 && request.status == 200){
		     if (typeof callback === 'function')
			 callback(request.responseText);
		 }
	     }
	     
	     request.open('POST', myurl, true);
	     request.setRequestHeader("Content-type",
				      "application/x-www-form-urlencoded");
	     console.log("sending params: " + params);
	     request.send(params);
	 }
	 
	 function askQ1(p, q){
	 	if (q1asked == false ){
	 		q1asked = true;
	 		q      = 'I have a question for you! \nIn impcore operational semantics, \nwhat kind of environment does \nphi represent?';
	 		wrong1 = 'Global Variable';
	 		wrong2 = 'Formal Variable';
	 		right  = 'Function';
	 		askQuestion(q, wrong1, wrong2, right, 'norman');
	 	}
	 }

	 function askQ2(p, q){
	 	if (q2asked == false) {
	 		q2asked = true;
	 		q      = "Mwahaha I've got a good question!\nWhen making server-side code \nwhen is it a good idea to trust \nuser input?";
	 		wrong1 = "Always! It's safe!";
	 		wrong2 = "Sometimes - its not very serious";
	 		right  = 'Never!';
	 		askQuestion(q, wrong1, wrong2, right, 'ming');
	 	}
	 }

	 function pauseGame(){
	 	timer.pause();
	 	game.camera.follow(null);
	 }

	 function unPausegame(){
	 	timer.resume();
	 	game.camera.follow(player);
	 }

	 function askQuestion(quest, wr1, wr2, right, prof){
	 	// stop the game timer and player movement
	 	pauseGame();

        var menu = game.add.sprite(game.camera.x + 3*(game.camera.width) / 4, h/2, 'answeroption');
        menu.scale.setTo(1.71,1.71);

        menu.anchor.setTo(0.5, 0.5);

        var prof = game.add.sprite(game.camera.x + 70, 197, prof);
     	prof.anchor.setTo(0.5,0.5);



     	var introText = game.add.text(game.camera.x + 3*(game.camera.width) / 4, 130, quest, {font:'24px Arial', fill:'#000'});
     	introText.anchor.setTo(.5, .5);

     	var wrong1 = game.add.text(game.camera.x + 1*(game.camera.width) / 2 + 15, 240, wr1, {font:'24px Arial', fill:'#000'});
     	wrong1.inputEnabled = true;
     	wrong1.events.onInputDown.add(function(){wrongAnswer(introText)});

     	var wrong2 = game.add.text(game.camera.x + 1*(game.camera.width) / 2 +15, 300, wr2, {font:'24px Arial', fill:'#000'});
     	wrong2.inputEnabled = true;
     	wrong2.events.onInputDown.add(function(){wrongAnswer(introText)});

     	var rightAns = game.add.text(game.camera.x + 1*(game.camera.width) / 2 + 15, 360, right, {font:'24px Arial', fill:'#000'});
     	rightAns.inputEnabled = true;
     	rightAns.events.onInputDown.add(function(){
     		introText.alpha = 0;
     		menu.alpha = 0;
     		prof.alpha = 0;
     		wrong1.alpha = 0;
     		wrong2.alpha = 0;
     		rightAns.alpha = 0;
     		unPausegame();
     	});
	 }

	 function wrongAnswer(text1){
	 	text1.text = "Wrong! Let's try again!";
	 }

	 function winGame(){
	 	if(finished == false){
	 		finished = true;
	 		endGame();
	 	}
	 }

	 function update() {
	     // check for collisions
	     game.physics.arcade.collide(player, barrier);

	     game.physics.arcade.overlap(player, q1, function(){askQ1(player, q1);}, null, this);
	     game.physics.arcade.overlap(player, q2, function(){askQ2(player, q2);}, null, this);
	  
	     game.physics.arcade.overlap(player, finish, winGame, null, this);
	     
	     
	     player.body.velocity.x = 0;
	     player.body.velocity.y = 0;
	     
	     if (cursors.left.isDown)
		 {
		     //  Move to the left
		     player.body.velocity.x = -150;
		     player.animations.play('lwalk', 5, true);
		 }
	     else if (cursors.right.isDown)
		 {
		     //  Move to the right
		     player.body.velocity.x = 150;
		     player.animations.play('rwalk', 5, true);
		 }
	     else if (cursors.up.isDown)
		 {
		     // Move up
		     player.body.velocity.y = -150;
		 }
	     else if (cursors.down.isDown)
		 {
		     // Move down
		     player.body.velocity.y = 150;
		 }
	     else{
		 player.animations.stop();
	     }
	 }
	</script>
    </body>
</html>
